<!DOCTYPE html>
<html>
<head>
  <title>Udacity Todos Goals</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/redux/3.7.2/redux.min.js"></script>
  <script src="https://unpkg.com/react@16.3.0-alpha.1/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@16.3.0-alpha.1/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/babel-standalone@6.15.0/babel.min.js"></script>
</head>
  <body>
    <div>
      <h1>Todo list</h1>
      <input id="todo" type="text" placeholder="Add Todo">
      <button id="todoBtn" type="button">Add Todo</button>
      <ul id="todos"></ul>
    </div>
    <div>
      <h1>Goals list</h1>
      <input id="goal" type="text" placeholder="Add Goal">
      <button id="goalBtn" type="button">Add Todo</button>
      <ul id="goals"></ul>
    </div>
    <hr />
    <div id='app'></div>
    <script type='text/javascript'>


      // App Code
      //replace string with const
      const ADD_TODO = 'ADD_TODO';
      const REMOVE_TODO = 'REMOVE_TODO';
      const TOGGLE_TODO = 'TOGGLE_TODO';
      const ADD_GOAL = 'ADD_GOAL';
      const REMOVE_GOAL = 'REMOVE_GOAL';

      //actionCreators
      function addTodoAction (todo) {
        return {
          type: ADD_TODO,
          todo
        }
      }

      function removeTodoAction (id) {
        return {
          type: REMOVE_TODO,
          id
        }
      }

      function toggleTodoAction (id) {
        return {
          type: TOGGLE_TODO,
          id
        }
      }

      function addGoalAction (goal) {
        return {
          type: ADD_GOAL,
          goal
        }
      }

      function removeGoalAction (id) {
        return {
          type: REMOVE_GOAL,
          id
        }
      }

      function todos (state = [], action) {
        switch (action.type) {
          case ADD_TODO:
            return state.concat([action.todo])
            //break;
          case REMOVE_TODO:
            return state.filter((todo) => todo.id !== action.id)
            //break;
          case TOGGLE_TODO:
            return state.map((todo) => todo.id !== action.id ? todo : Object.assign({}, todo, {complete: !todo.complete}))
            //break;
          default:
            return state
        }

        //use switch instead to clean up code
        // if (action.type === 'ADD_TODO') {
        //   return state.concat([action.todo])
        // } else if (action.type === 'REMOVE_TODO') {
        //   return state.filter((todo) => todo.id !== action.id)
        // } else if (action.type === 'TOGGLE_TODO') {
        //   return state.map((todo) => todo.id !== action.id ? todo : Object.assign({}, todo, {complete: !todo.complete}))
        // } else {
        //   return state
        // }

      }

      function goals (state=[],action){
        switch (action.type) {
          case ADD_GOAL:
            return state.concat([action.goal])
          case REMOVE_GOAL:
            return state.filter((goal) => goal.id !== action.id)
          default:
            return state
        }
      }

      //Middleware
      // function checkAndDispatch(store, action){
      //   if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')) {
      //     return alert('Try another one')
      //   }
      //   if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')) {
      //     return alert('Try another one')
      //   }
      //   return store.dispatch(action)
      // }

      // function app (state=[],action){
      //   return {
      //     todos: todos(state.todos, action),
      //     goals: goals(state.goals, action)
      //   }
      // }

      // Redux.combineReducers({
      //   todos,
      //   goals
      // })

      //Redux Middleware
      // function checker(store){
      //   return function (next){
      //     return function (action){
      //       if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')) {
      //         return alert('Try another one')
      //       }
      //       if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')) {
      //         return alert('Try another one')
      //       }
      //       return next(action)
      //     }
      //   }
      // }

      //ES6 Version of Redux Middleware
      const checker = (store) => (next) => (action) => {
        if (action.type === ADD_TODO && action.todo.name.toLowerCase().includes('bitcoin')) {
          return alert('Try another one')
        }
        if (action.type === ADD_GOAL && action.goal.name.toLowerCase().includes('bitcoin')) {
          return alert('Try another one')
        }
        return next(action)
      }

      //logger middleware
      const logger = (store) => (next) => (action) => {
        console.group(action.type);
          console.log("The action:",action);
          const dispatchResult = next(action);
          console.log("The new state:", store.getState());
        console.groupEnd();
        return dispatchResult;
      }

      //replace createStore(app) with Redux.createStore API
      //replace app function with Redux.combineReducers
      //const store = Redux.createStore(rootReducer, Redux.applyMiddleware(checker))
      //applyMiddleware(...middlewares).Note the spread operator on the middlewares parameter. This means that we can pass in as many different middleware as we want! Middleware is called in the order in which they were provided to applyMiddleware().
      //Redux's createStore() method takes the reducer function as its first argument, but then it can take a second argument of the middleware functions to run. Because we set up the Redux store with knowledge of the middleware function, it runs the middleware function between store.dispatch() and the invocation of the reducer.
      const store = Redux.createStore(Redux.combineReducers({
        todos,
        goals
      }), Redux.applyMiddleware(checker,logger));

      store.subscribe(() => {
           //console.log('The new state is: ', store.getState())
           const {goals, todos} = store.getState();
           //reset
           document.getElementById('goals').innerHTML = '';
           document.getElementById('todos').innerHTML = '';
           //foreach add nodetext
           goals.forEach(addGoalToDom);
           todos.forEach(addTodoToDom);
      })

      // store.dispatch(addTodoAction({
      //   id: 0,
      //   name: 'Walk the dog',
      //   complete: false,
      // }))
      //
      // store.dispatch(addTodoAction({
      //   id: 1,
      //   name: 'Wash the car',
      //   complete: false,
      // }))
      //
      // store.dispatch(addTodoAction({
      //   id: 2,
      //   name: 'Go to the gym',
      //   complete: true,
      // }))
      //
      // store.dispatch(removeTodoAction(1))
      //
      // store.dispatch(toggleTodoAction(0))
      //
      // store.dispatch(addGoalAction({
      //   id: 0,
      //   name: 'Learn Redux'
      // }))
      //
      // store.dispatch(addGoalAction({
      //   id: 1,
      //   name: 'Lose 20 pounds'
      // }))
      //
      // store.dispatch(removeGoalAction(0))
      function generateId () {
        return Math.random().toString(36).substring(2) + (new Date()).getTime().toString(36);
      }

      //DOM code
      function addTodo (){
        const input = document.getElementById('todo');
        const todoName = input.value;
        input.value = '';

        store.dispatch(addTodoAction({
          id: generateId (),
          name: todoName,
          complete: false,
        }))
      }

      function addGoal (){
        const input = document.getElementById('goal');
        const goalName = input.value;
        input.value = '';

        store.dispatch(addGoalAction({
          id: generateId (),
          name: goalName,
          complete: false,
        }))
      }

      document.getElementById('todoBtn').addEventListener('click',addTodo);
      document.getElementById('goalBtn').addEventListener('click',addGoal);
      //createRemoveButton
      //onClick parameter is expected to be a function
      //Higher-order functions are a powerful programming technique that allow functions to be significantly more dynamic. You've actually already written a higher-order function in this course. The createRemoveButton() function is a higher-order function because the onClick parameter is expected to be a function (because onClick is set up as an event listener callback function.
      function createRemoveButton(onClick){
        const removeBtn = document.createElement('button');
        removeBtn.innerHTML='X';
        removeBtn.addEventListener('click', onClick);
        return removeBtn;
      }

      // accessing elements with document.getElementById()
      // adding listeners with .addEventListener()
      // accessing the .value property on an element
      // creating a new element with .createElement()
      // adding new content with.appendChild()
      function addTodoToDom(todo){
        const node = document.createElement('li');
        const text = document.createTextNode(todo.name);
        //add removeBtn
        const removeBtn = createRemoveButton(() => {
          store.dispatch(removeTodoAction(todo.id))
        })
        node.appendChild(text);
        node.appendChild(removeBtn);
        //click to toggle
        node.style.textDecoration = todo.complete ? 'line-through' : 'none';
        node.addEventListener('click', () => {
          store.dispatch(toggleTodoAction(todo.id))
        })
        document.getElementById('todos').append(node);
      }

      function addGoalToDom(goal){
        const node = document.createElement('li');
        const text = document.createTextNode(goal.name);
        //add removeBtn
        const removeBtn = createRemoveButton(() => {
          store.dispatch(removeGoalAction(goal.id))
        })
        node.appendChild(text);
        node.appendChild(removeBtn);
        document.getElementById('goals').append(node);
      }
    </script>
    <script type="text/babel">
    function List (props){
      return (
        <ul>
          <li>List</li>
        </ul>
      )
    }

    class Todos extends React.Component {
       addItem = (e) => {
        e.preventDefault();
        const name = this.inputElement.value;
        this.inputElement.value = '';
        this.props.store.dispatch(addGoalAction({
          id: generateId (),
          name: name,
          complete: false,
        }))
      }
      render() {
        return (
          <div>
            <h1>Todos</h1>
            <input
              type='text'
              placeholder='Add todo'
              ref={(input) => this.inputElement = input}
            />
            <button onClick={this.addItem}>Add Todo</button>
            <List />
          </div>

        )
      }
    }

    class Goals extends React.Component {
      render() {
        return (
          <div>
            Goals
            <List />
          </div>

        )
      }
    }

    class App extends React.Component {
      render() {
        return (
          <div>
            <Todos store={this.props.store}/>
            <Goals />
          </div>
        )
      }
    }

    ReactDOM.render(
      <App store={store}/>,
      document.getElementById('app')
    )
    </script>
  </body>
</html>
